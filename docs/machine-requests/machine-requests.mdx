---
title: Machine-to-Machine Requests
description: Learn how to use machine tokens to make and verify authenticated requests.
---

## Introduction

Machine-to-machine (M2M) authentication allows services, scripts, or devices to securely communicate with each other without the need for a user's session.

For example, you might need machine tokens for:

- Cron jobs that update your database
- Background workers processing queued tasks
- Microservices communicating with each other

## Creating Machine Requests

If your client is a backend service, you can create a machine token using the [clerk backend api](https://clerk.com/docs/reference/backend-api/tag/machine-tokens). Then use the created token in the `Authorization` header of outgoing request.

> [!WARNING]
> Because creating machine tokens using [clerk backend api](https://clerk.com/docs/reference/backend-api/tag/machine-tokens), it is subject to the [Backend API rate limits](/docs/rate-limits).

### Example using the Clerk JavaScript Backend SDK

```tsx
import { createClerkClient } from '@clerk/backend'

export default async function cronJob() {
  const clerkClient = createClerkClient({ secretKey: process.env.CLERK_SECRET_KEY })

  const { token } = await clerkClient.machineTokens.create({
    machineId: 'mch_cron',
    claims: {
      permissions: ['read', 'write'],
    },
    expiresInSeconds: 60,
  })

  await fetch('https://api.example.com/cron', {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${token}`,
    },
    body: JSON.stringify({
      message: 'Hello World!',
    }),
  })
}
```

## Verifying Machine Requests

For a machine request to be valid, it must include a valid [machine token](/docs/machine-requests/machine-tokens) in the Bearer `Authorization` header.

You can verify machine tokens in two ways:

1. Using Clerk's Backend SDKs (recommended)
2. Manually verifying the machine token JWT using your instance's public key.

### Examples Using Clerk's Backend SDKs

  <Tabs items={['Next.js Middleware', 'Next.js API Route', 'Node.js HTTP Server']}>
    <Tab>
      ```tsx import { clerkMiddleware, createRouteMatcher } from "@clerk/nextjs/server";

      const isMachineRoute = createRouteMatcher(["/api/cron"]);

      export default clerkMiddleware(async (auth, req) => {
        if (isMachineRoute(req)) {
          const { isMachineAuthenticated } = await auth({ entity: "machine" });
          if (!isMachineAuthenticated) {
            return new Response("Unauthorized", { status: 401 });
          }
        }
      });
 
      export const config = {
        matcher: ["/((?!.*\\..*|_next).*)", "/"],
      };
         ```
    </Tab>

    <Tab>
    ```tsx import { auth } from '@clerk/nextjs/server';
    import { NextResponse } from 'next/server';
    import { runCronJob } from './cronJob';

      export const POST = async () => {
        const { isMachineAuthenticated } = await auth({ entity: 'machine' });

        if (!isMachineAuthenticated) {
          return NextResponse.json({ message: 'Unauthorized' }, { status: 401 });
        }

        await runCronJob();

        return NextResponse.json({ message: 'Cron job ran' });
      };
    ```
    </Tab>

    <Tab>
      ```tsx
      import { createClerkClient } from '@clerk/backend';
      import http from 'http';

      const clerk = createClerkClient({ secretKey: process.env.CLERK_SECRET_KEY });

      const server = http.createServer(async (req, res) => {
        try {
          const { isValid } = await clerk.authenticateRequest(req, { 
            entity: 'machine',
          });

          if (!isValid) {
            res.writeHead(401);
            res.end(JSON.stringify({ message: 'Unauthorized' }));
            return;
          }

          await runCronJob();
          
          res.writeHead(200);
          res.end(JSON.stringify({ message: 'Success' }));
        } catch (err) {
          res.writeHead(500);
          res.end(JSON.stringify({ message: 'Internal Server Error' }));
        }
      });

      server.listen(3000, () => {
        console.log('Server running on port 3000');
      });
      ```
    </Tab>
  </Tabs>


